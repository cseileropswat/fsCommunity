(()=>{"use strict";var t=function(){function t(){}return t.getInstance=function(){return null===t.instance?new t:t.instance},t.prototype.get=function(t){return chrome.storage.local.get(t)},t.prototype.set=function(t,e){var n;return chrome.storage.local.set(((n={})[t]=e,n))},t.instance=null,t}().getInstance(),e=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function c(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}s((r=r.apply(t,e||[])).next())}))},n=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},r="api_key",o="base_url",i="scan_download",a="max_filesize",c="scan_history";function s(){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,t.get(r)];case 1:return[2,e.sent().api_key]}}))}))}function u(){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,t.get(o)];case 1:return[2,e.sent().base_url]}}))}))}function l(){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,t.get(i)];case 1:return[2,e.sent().scan_download]}}))}))}function f(){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,t.get(a)];case 1:return[2,e.sent().max_filesize]}}))}))}function h(r){return e(this,void 0,void 0,(function(){return n(this,(function(e){switch(e.label){case 0:return[4,t.set(c,r)];case 1:return[2,e.sent()]}}))}))}function d(){return e(this,void 0,void 0,(function(){var e;return n(this,(function(n){switch(n.label){case 0:return[4,t.get(c)];case 1:return(e=n.sent())&&e.scan_history?[2,e.scan_history]:[2,[]]}}))}))}var p=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function c(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}s((r=r.apply(t,e||[])).next())}))},v=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},y=function(){function t(t,e){this.baseUrl=t,this.apiKey=e}return t.prototype.getHeaders=function(t){return void 0===t&&(t="application/json"),{"x-api-key":this.apiKey}},t.prototype.get=function(t,e){return p(this,void 0,void 0,(function(){return v(this,(function(n){return[2,fetch(this.baseUrl+t+"?"+e,{headers:this.getHeaders(),method:"GET"}).then((function(t){if(t.status>=200&&t.status<300)return t.json();throw Error("".concat(t.status,": ").concat(t.statusText))}))]}))}))},t.prototype.post=function(t,e){return p(this,void 0,void 0,(function(){var n,r;return v(this,(function(o){for(r in n=new URLSearchParams,e)n.append(r,e[r]);return[2,fetch(this.baseUrl+t,{headers:this.getHeaders("application/x-www-form-urlencoded"),method:"POST",body:n}).then((function(t){if(t.status>=200&&t.status<300)return t.json();throw Error("".concat(t.status,": ").concat(t.statusText))}))]}))}))},t.prototype.postForm=function(t,e){return p(this,void 0,void 0,(function(){return v(this,(function(n){return[2,fetch(this.baseUrl+t,{headers:this.getHeaders("multipart/form-data"),method:"POST",body:e}).then((function(t){if(t.status>=200&&t.status<300)return t.json();throw Error("".concat(t.status,": ").concat(t.statusText))}))]}))}))},t}();function b(t,e,n){void 0===n&&(n="/images/icon-48.png"),chrome.notifications.create({type:"basic",iconUrl:n,title:"FileScan.IO for chrome",message:t,isClickable:!0,priority:2},(function(t){e&&setTimeout((function(){chrome.notifications.clear(t)}),e)}))}var m=function(t,e,n,r){return new(n||(n=Promise))((function(o,i){function a(t){try{s(r.next(t))}catch(t){i(t)}}function c(t){try{s(r.throw(t))}catch(t){i(t)}}function s(t){var e;t.done?o(t.value):(e=t.value,e instanceof n?e:new n((function(t){t(e)}))).then(a,c)}s((r=r.apply(t,e||[])).next())}))},g=function(t,e){var n,r,o,i,a={label:0,sent:function(){if(1&o[0])throw o[1];return o[1]},trys:[],ops:[]};return i={next:c(0),throw:c(1),return:c(2)},"function"==typeof Symbol&&(i[Symbol.iterator]=function(){return this}),i;function c(i){return function(c){return function(i){if(n)throw new TypeError("Generator is already executing.");for(;a;)try{if(n=1,r&&(o=2&i[0]?r.return:i[0]?r.throw||((o=r.return)&&o.call(r),0):r.next)&&!(o=o.call(r,i[1])).done)return o;switch(r=0,o&&(i=[2&i[0],o.value]),i[0]){case 0:case 1:o=i;break;case 4:return a.label++,{value:i[1],done:!1};case 5:a.label++,r=i[1],i=[0];continue;case 7:i=a.ops.pop(),a.trys.pop();continue;default:if(!(o=a.trys,(o=o.length>0&&o[o.length-1])||6!==i[0]&&2!==i[0])){a=0;continue}if(3===i[0]&&(!o||i[1]>o[0]&&i[1]<o[3])){a.label=i[1];break}if(6===i[0]&&a.label<o[1]){a.label=o[1],o=i;break}if(o&&a.label<o[2]){a.label=o[2],a.ops.push(i);break}o[2]&&a.ops.pop(),a.trys.pop();continue}i=e.call(t,a)}catch(t){i=[6,t],r=0}finally{n=o=0}if(5&i[0])throw i[1];return{value:i[0]?i[1]:void 0,done:!0}}([i,c])}}},w=function(t,e,n){if(n||2===arguments.length)for(var r,o=0,i=e.length;o<i;o++)!r&&o in e||(r||(r=Array.prototype.slice.call(e,0,o)),r[o]=e[o]);return t.concat(r||Array.prototype.slice.call(e))},k=["malicious","likely_malicious","suspicious","informational","benign","unknown"],x=["success_partial","success","failed","failed_partial"];function _(t,e,n){return"".concat(t,"/uploads/").concat(e,"/reports/").concat(n)}function S(t){var e,n;return m(this,void 0,void 0,(function(){var r,o,i,a,c,h,d,p,v,m;return g(this,(function(g){switch(g.label){case 0:return g.trys.push([0,7,,8]),[4,s()];case 1:return r=g.sent(),[4,u()];case 2:return o=g.sent(),[4,l()];case 3:return i=null!==(e=g.sent())&&void 0!==e&&e,[4,f()];case 4:return a=null!==(n=g.sent())&&void 0!==n?n:0,i?a>0&&t.size>a?(b("File is too large(Limit: ".concat(a,")"),5e3),[2]):(c=new y(o,r),(h=new FormData).append("file",t,t.name),d=t.name,b("Scan started for ".concat(d),5e3),[4,c.postForm("/api/scan/file",h)]):[2];case 5:if(p=g.sent(),!(v=p.flow_id))throw Error("Invalid flow id");return[4,I(c,o,v)];case 6:return g.sent(),[3,8];case 7:return m=g.sent(),console.log(m),[3,8];case 8:return[2]}}))}))}function I(t,e,n){return m(this,void 0,void 0,(function(){var r,o,i,a,c,s;return g(this,(function(u){switch(u.label){case 0:r="filter=finalVerdict&filter=general&filter=taskReference&filter=overallState&filter=subtaskReferences&sorting=allSignalGroups%28description%3Aasc%2CaverageSignalStrength%3Adesc%29&sorting=allTags%28tag.name%3Aasc%29",u.label=1;case 1:return[4,t.get("/api/scan/".concat(n,"/report"),r)];case 2:o=u.sent(),i=function(t,e,n){var r=n.reports;if(!r)return null;var o=Object.keys(r).map((function(n){var o,i,a,c,s=r[n];return{flowId:e,reportId:n,link:_(t,e,n),created:s.created_date,name:null===(o=s.file)||void 0===o?void 0:o.name,hash:null===(i=s.file)||void 0===i?void 0:i.hash,verdict:null===(c=null===(a=s.finalVerdict)||void 0===a?void 0:a.verdict)||void 0===c?void 0:c.toLowerCase(),status:s.overallState}}));return o}(e,n,o),u.label=3;case 3:return u.trys.push([3,8,,9]),i?function(t){for(var e=0,n=t;e<n.length;e++){if(r=n[e].status,!x.includes(r))return!1}var r;return!0}(i)&&i.length>0?[4,d()]:[3,6]:[3,7];case 4:return a=u.sent(),[4,h(w(w([],a,!0),i,!0))];case 5:return u.sent(),c=function(t){for(var e=k.length-1,n=0,r=t;n<r.length;n++){var o=r[n],i=k.indexOf(o.verdict);i<e&&(e=i)}return k[e]}(i),b("Scan completed: ".concat(c),5e3,"/images/icon-48".concat(function(t){return"malicious"===t?"m":"likely_malicious"===t?"lm":"suspicious"===t?"s":""}(c),".png")),chrome.runtime.sendMessage({type:"scanning",finished:!0,scans:i}),[3,11];case 6:chrome.runtime.sendMessage({type:"scanning",scans:i}),u.label=7;case 7:return[3,9];case 8:return s=u.sent(),console.log(s),b("Error occured during scanning: ".concat(s),5e3),[3,11];case 9:return[4,(l=1e3,new Promise((function(t){return setTimeout(t,l)})))];case 10:return u.sent(),[3,1];case 11:return[2]}var l}))}))}chrome.runtime.onInstalled.addListener((function(){chrome.tabs.create({url:chrome.runtime.getURL("html/panel.html?tab=setting")})})),chrome.contextMenus.onClicked.addListener((function(t,e){"Filescan extension"===t.menuItemId&&function(t){m(this,void 0,void 0,(function(){var e,n,r,o,i,a,c;return g(this,(function(l){switch(l.label){case 0:return l.trys.push([0,5,,6]),[4,s()];case 1:return e=l.sent(),[4,u()];case 2:return n=l.sent(),r=new y(n,e),o=t.substring(t.lastIndexOf("/")+1),b("Scan started for ".concat(o),5e3),[4,r.post("/api/scan/url",{url:t})];case 3:if(i=l.sent(),!(a=i.flow_id))throw Error("Invalid flow id");return[4,I(r,n,a)];case 4:return l.sent(),[3,6];case 5:return c=l.sent(),console.log(c),[3,6];case 6:return[2]}}))}))}(t.linkUrl)})),chrome.runtime.onMessage.addListener((function(t,e,n){switch(t.cmd){case"get_base_url":u().then((t=>{n(t)}));break;case"get_api_key":s().then((t=>{n(t)}));break;case"get_history":d().then((t=>{n(t)}));break;default:n(null)}return!0})),chrome.downloads.onChanged.addListener((async function(t){if("complete"===t.state?.current){const e=await chrome.downloads.search({id:t.id});for(const t of e){if(0===t.totalBytes)continue;T("file:///"+t.filename.replace(/\\/g,"/"),(t=>{S(t)}))}}}));function T(t,e){const n=t.lastIndexOf("/"),r=t.substring(n+1);!function(t,e){fetch(t).then((t=>t.blob())).then((t=>e(t)))}(t,(function(t){e(function(t,e,n){return new File([t],e,{type:n})}(t,r,t.type))}))}})();